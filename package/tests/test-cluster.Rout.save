
R version 3.1.0 (2014-04-10) -- "Spring Dance"
Copyright (C) 2014 The R Foundation for Statistical Computing
Platform: x86_64-unknown-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> ####################################################################################################
> # This tests the clusterPairs function.
> 
> suppressPackageStartupMessages(require(diffHic))
> 
> ####################################################################################################
> 
> simgen <- function(alln, chromos, width, min.space, max.space) {
+ 	# Randomly sampling chromosomes to generate both a pair matrix and the chromosome space.
+ 	output <- GRanges()
+ 	for (x in names(chromos)) {
+ 		n <- chromos[[x]]
+ 		gaps <- round(runif(n, min.space, max.space))
+ 		starts <- cumsum(gaps)
+ 		ends <- starts + width
+ 		suppressWarnings(output <- c(output, GRanges(x, IRanges(starts, ends))))
+ 	}
+ 	
+ 	# Randomly sampling pairs.
+    	total <- length(output)
+    	chosen1 <- round(runif(alln, 1, total))
+    	chosen2 <- round(runif(alln, 1, total))
+    	chosen.a <- pmax(chosen1, chosen2)
+    	chosen.t <- pmin(chosen1, chosen2)
+ 
+ 	# Enforcing uniqueness and anchor/target properties.
+    	o <- order(chosen.a, chosen.t)
+    	chosen.a <- chosen.a[o]
+    	chosen.t <- chosen.t[o]
+    	is.diff <- c(TRUE, diff(chosen.a)!=0 | diff(chosen.t)!=0)
+    	pairs <- data.frame(anchor.id=chosen.a, target.id=chosen.t)
+ 	return(list(pairs=pairs, region=output))
+ }
> 
> crisscross <- function(id1, id2) {
+ 	out <- split(id1, id2)
+ 	if (!all(sapply(out, FUN=function(x) { length(unique(x))==1 }))) {
+ 		return(FALSE)
+ 	}
+ 	out <- split(id2, id1)
+ 	if (!all(sapply(out, FUN=function(x) { length(unique(x))==1 }))) {
+ 		return(FALSE)
+ 	}
+ 	return(TRUE)
+ }
> 
> clustercomp <- function(pairs, region, tol, maxw, debug=FALSE) {
+ 	# Simulating cluster formation first, by expanding each region and checking for overlaps.
+ 	# We use a simple quadratic-time algorithm; slow, but gets the job done.
+ 	expanded <- resize(region, fix="center", width(region)+tol*2)
+ 	allap <- findOverlaps(expanded, region)
+ 	impossible <- nrow(pairs)+1L
+ 	myids <- rep(impossible, nrow(pairs))
+ 	last.id <- 1L
+ 
+ 	for (x in 1:nrow(pairs)) {
+ 		cura <- pairs$anchor.id[x]
+ 		keep.a <- subjectHits(allap)[queryHits(allap)==cura]
+ 		curt <- pairs$target.id[x]
+ 		keep.t <- subjectHits(allap)[queryHits(allap)==curt]
+ 
+ 		partners <- which(pairs$anchor.id %in% keep.a & pairs$target.id %in% keep.t)
+ 		partners <- partners[partners>=x]
+ 		curids <- myids[partners]
+ 		curids <- curids[curids!=impossible]
+ 		
+ 		chosen <- unique(curids)
+ 		if (length(chosen)>1L) { 
+ 			chosen <- min(curids)
+ 			myids[myids%in%curids]<-chosen
+ 		} else if (!length(curids)) {
+ 			chosen <- last.id
+ 			last.id <- last.id + 1L
+ 		} 
+ 		myids[partners]	<- chosen
+ 	}
+ 
+ 	comp <- clusterPairs(pairs, region, tol=tol, upper=NULL)
+ 	if (!crisscross(comp, myids)) { stop("mismatches in cluster IDs without bin size restriction") }
+ 
+ # Some error checking functions; just define 'current' as the pairs of interest.
+ # targets <- which(sapply(split(comp, myids), FUN=function(x) { length(unique(x))!=1 }))
+ # current <- pairs[myid==targets[1],]
+ # plot(0,0,xlim=c(1075, 1358),ylim=c(1163,1475))
+ # rect(start(region)[current$t], start(region)[current$t], end(region)[current$a], end(region)[current$t], col=rgb(1,0,0,0.5))
+ 
+ 	# Now, splitting each cluster to keep them under maxw.
+ 	clusters <- split(1:nrow(pairs), comp)
+ 	all.starts <- start(region)
+ 	all.ends <- end(region)+1L
+ 	last <- 0
+ 	myid2 <- myids
+ 	for (x in names(clusters)) {
+ 		active <- clusters[[x]]
+ 		active.a <- pairs$anchor.id[active]
+ 		active.t <- pairs$target.id[active]
+ 
+ 		cluster.as <- min(all.starts[active.a])
+ 		cluster.ae <- max(all.ends[active.a])
+ 		cluster.ts <- min(all.starts[active.t])
+ 		cluster.te <- max(all.ends[active.t])
+ 
+ 		diff.a <- cluster.ae - cluster.as 
+ 		mult.a <- ceiling(diff.a / maxw)
+ 		jump.a <- diff.a/mult.a
+ 
+ 		diff.t <- cluster.te - cluster.ts 
+ 		mult.t <- ceiling(diff.t / maxw)
+ 		jump.t <- diff.t/mult.t
+ 
+ 		mid.a <- (all.starts[active.a]+all.ends[active.a]) * 0.5
+ 		ax <- floor((mid.a - cluster.as)/jump.a)
+ 		mid.t <- (all.starts[active.t]+all.ends[active.t]) * 0.5
+ 		tx <- floor((mid.t - cluster.ts)/jump.t)
+ 
+ 		myid2[active] <- ax * mult.t + tx + last
+ 		last <- last + mult.t*mult.a
+ 	}
+ 
+ 	# Comparing  it to the actual clustering.
+ 	comp2 <- clusterPairs(pairs, region, tol=tol, upper=maxw)
+ 	if (!crisscross(comp2, myid2)) { stop("mismatches in cluster IDs when a maximum bin size is applied") }
+ 	return(summary(tabulate(comp)))
+ }
> 
> ####################################################################################################
> 
> set.seed(3413094)
> 
> chromos <- c(chrA=10, chrB=20, chrC=40)
> data <- simgen(100, chromos, 20, 50, 100)
> clustercomp(data$pairs, data$region, tol=70, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   1.000   1.176   1.000   3.000 
> clustercomp(data$pairs, data$region, tol=100, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   1.000   1.299   1.000   3.000 
> clustercomp(data$pairs, data$region, tol=200, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   1.500   2.273   3.000  11.000 
> 
> data <- simgen(100, chromos, 10, 50, 100)
> clustercomp(data$pairs, data$region, tol=70, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   1.000   1.064   1.000   3.000 
> clustercomp(data$pairs, data$region, tol=100, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   1.000   1.136   1.000   3.000 
> clustercomp(data$pairs, data$region, tol=200, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   1.000   1.786   2.000  10.000 
> 
> data <- simgen(500, chromos, 20, 50, 100)
> clustercomp(data$pairs, data$region, tol=70, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   1.000   1.916   2.000  10.000 
> clustercomp(data$pairs, data$region, tol=100, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   2.000   2.703   3.000  23.000 
> clustercomp(data$pairs, data$region, tol=200, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   1.00    2.50    8.00   26.32   31.00  157.00 
> 
> data <- simgen(500, chromos, 10, 50, 100)
> clustercomp(data$pairs, data$region, tol=70, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   1.000   1.493   2.000   8.000 
> clustercomp(data$pairs, data$region, tol=100, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   2.000   2.632   3.000  20.000 
> clustercomp(data$pairs, data$region, tol=200, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   1.00    1.00    4.00   23.81   21.00  172.00 
> 
> data <- simgen(1000, chromos, 20, 50, 100)
> clustercomp(data$pairs, data$region, tol=70, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   2.000   3.922   5.000  30.000 
> clustercomp(data$pairs, data$region, tol=100, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   3.000   9.009   8.500 116.000 
> clustercomp(data$pairs, data$region, tol=200, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
    2.0    44.0    98.0   142.9   233.5   345.0 
> 
> data <- simgen(1000, chromos, 10, 50, 100)
> clustercomp(data$pairs, data$region, tol=70, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   1.000   2.203   3.000  21.000 
> clustercomp(data$pairs, data$region, tol=100, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   2.000   7.937   7.000  93.000 
> clustercomp(data$pairs, data$region, tol=200, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  16.00   86.25  120.00  166.70  275.20  342.00 
> 
> # And again, with flipped settings.	
> data <- simgen(100, chromos, 50, 10, 20)
> clustercomp(data$pairs, data$region, tol=0, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   1.00    1.00    2.00    2.50    3.25    8.00 
> clustercomp(data$pairs, data$region, tol=20, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  1.000   1.000   2.000   4.348   4.500  26.000 
> clustercomp(data$pairs, data$region, tol=50, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   2.00    4.00    8.00   11.11   16.00   33.00 
> 
> data <- simgen(100, chromos, 100, 10, 20)
> clustercomp(data$pairs, data$region, tol=0, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   2.00    3.25    4.50   10.00   10.50   35.00 
> clustercomp(data$pairs, data$region, tol=20, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   2.00    3.75    6.00   12.50   17.00   35.00 
> clustercomp(data$pairs, data$region, tol=50, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   2.00    5.50    8.00   14.29   22.00   35.00 
> 
> data <- simgen(500, chromos, 50, 10, 20)
> clustercomp(data$pairs, data$region, tol=0, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   7.00   46.25   61.50   83.33  137.50  166.00 
> clustercomp(data$pairs, data$region, tol=20, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   7.00   46.25   61.50   83.33  137.50  166.00 
> clustercomp(data$pairs, data$region, tol=50, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   7.00   46.25   61.50   83.33  137.50  166.00 
> 
> data <- simgen(500, chromos, 100, 10, 20)
> clustercomp(data$pairs, data$region, tol=0, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   8.00   37.75   60.50   83.33  140.20  174.00 
> clustercomp(data$pairs, data$region, tol=20, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   8.00   37.75   60.50   83.33  140.20  174.00 
> clustercomp(data$pairs, data$region, tol=50, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
   8.00   37.75   60.50   83.33  140.20  174.00 
> 
> data <- simgen(1000, chromos, 50, 10, 20)
> clustercomp(data$pairs, data$region, tol=0, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  24.00   81.75  123.50  166.70  272.50  339.00 
> clustercomp(data$pairs, data$region, tol=20, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  24.00   81.75  123.50  166.70  272.50  339.00 
> clustercomp(data$pairs, data$region, tol=50, maxw=200)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  24.00   81.75  123.50  166.70  272.50  339.00 
> 
> data <- simgen(1000, chromos, 100, 10, 20)
> clustercomp(data$pairs, data$region, tol=0, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  23.00   80.75  116.00  166.70  284.00  336.00 
> clustercomp(data$pairs, data$region, tol=20, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  23.00   80.75  116.00  166.70  284.00  336.00 
> clustercomp(data$pairs, data$region, tol=50, maxw=500)
   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
  23.00   80.75  116.00  166.70  284.00  336.00 
> 
> ####################################################################################################
> ####################################################################################################
> ####################################################################################################
> 
> 
> proc.time()
   user  system elapsed 
 16.618   0.061  16.712 
